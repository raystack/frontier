# Build the UI
FROM node:20-alpine as admin-builder
RUN apk add --no-cache make git
RUN npm install -g pnpm@9.3.0
WORKDIR /app

COPY web/apps/admin ./web/apps/admin
COPY Makefile .
RUN make admin-app

# Build the Go binary
FROM golang:1.23.1-alpine3.20 as builder
RUN apk add --no-cache make
WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .
COPY --from=admin-builder /app/web/apps/admin/dist /app/web/apps/admin/dist

RUN make build

# Build the final image
FROM alpine:3.18
COPY --from=builder /app/frontier /usr/bin/
RUN apk update && \
    apk add --no-cache ca-certificates libc6-compat && \
    rm -rf /var/cache/apk/*

ENTRYPOINT ["frontier"]
